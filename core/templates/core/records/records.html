{% extends "core/base.html" %}
{% block title %}Nahrávky{% endblock %}

{% block content %}

<style>
  .page-header {
    margin-bottom: 20px;
  }

  audio {
      position: relative;
      z-index: 1;
  }
</style>

<!-- FILTER BAR -->
<div class="bg-white border rounded-3 shadow-sm mb-3 px-3"
     style="height: 60px; display:flex; align-items:center;">

    <div class="d-flex align-items-center gap-3 w-100">

        <!-- DATE INPUT (NOW FIRST) -->
        <input id="dateInput"
               type="text"
               class="form-control"
               placeholder="Zvolte období (YYYY-MM-DD)"
               style="width: 240px;"
               value="{{ date_query }}"
               onkeydown="if(event.key==='Enter'){applyFilters();}">

        <!-- FILTER TYPE -->
        <select id="filterSelect"
                class="form-select form-select-sm"
                style="width: 280px;"
                onchange="applyFilters()">

            <option value="probability"
                {% if current_filter == 'probability' %}selected{% endif %}>
                Podle pravděpodobnosti detekce
            </option>

            <option value="date"
                {% if current_filter == 'date' %}selected{% endif %}>
                Chronologicky
            </option>
        </select>

        <!-- SORT -->
        <select id="sortSelect"
                class="form-select form-select-sm"
                style="width: 130px;"
                onchange="applyFilters()">

            <option value="asc"
                {% if current_sort == 'asc' %}selected{% endif %}>
                Vzestupně
            </option>

            <option value="desc"
                {% if current_sort == 'desc' %}selected{% endif %}>
                Sestupně
            </option>
        </select>

        <div class="ms-auto"></div>

    </div>
</div>



<!-- TABLE WRAPPER -->
<div class="bg-white border rounded-3 shadow-sm mt-3 p-3">
    <div style="max-height: calc(100vh - 260px); overflow-y: auto;">

{% if records_list %}

<table class="table table-hover align-middle mb-0">
<thead class="table-light position-sticky top-0" style="z-index: 10; background:white;">
<tr>
    <th style="width: 150px;">Datum</th>
    <th style="width: 120px;">Čas</th>
    <th style="width: 400px;">Nahrávka</th>
    <th>Pravděpodobnost</th>
    <th class="text-end" style="width: 90px;"></th>
</tr>
</thead>

<tbody>
{% for rec in records_list %}
<tr>
    <td>{{ rec.date_time|date:"Y-m-d" }}</td>
    <td>{{ rec.date_time|time:"H:i:s" }}</td>

    <td>
        <audio controls style="height:32px;">
          <source src="{{ rec.audio_file.url }}" type="audio/wav">
        </audio>
    </td>

    <td>
        {% if rec.detection_probability %}
            {{ rec.detection_probability|floatformat:2 }} %
        {% else %}
            <span class="text-muted">–</span>
        {% endif %}
    </td>

    <td class="text-end">
        <div class="d-inline-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary"
                    onclick="recordLanding('{{ rec.id }}')">
                <span class="material-icons">flight_land</span>
            </button>

            <button class="btn btn-sm btn-outline-danger"
                    onclick="deleteRecord('{{ rec.id }}')">
                <span class="material-icons">delete</span>
            </button>
        </div>
    </td>
</tr>
{% endfor %}
</tbody>
</table>

{% else %}
<div class="text-center text-muted py-4 fs-5">
    Žádné záznamy nebyly nalezeny.
</div>
{% endif %}

    </div>
</div>



<!-- PAGINATION -->
<div class="d-flex justify-content-between align-items-center mt-3">

  <!-- PAGE SIZE -->
  <div class="btn-group" role="group">
    {% for size in page_sizes %}
      <a href="?page={{ records_list.number }}&size={{ size }}&filter={{ current_filter }}&sort={{ current_sort }}&date={{ date_query }}"
         class="btn btn-sm {% if page_size == size %}btn-primary{% else %}btn-secondary{% endif %}">
        {{ size }}
      </a>
    {% endfor %}
  </div>

  <!-- PAGE LINKS -->
  <nav>
    <ul class="pagination mb-0">

      {% if records_list.has_previous %}
        <li class="page-item">
          <a class="page-link"
             href="?page=1&size={{ page_size }}&filter={{ current_filter }}&sort={{ current_sort }}&date={{ date_query }}">«</a>
        </li>

        <li class="page-item">
          <a class="page-link"
             href="?page={{ records_list.previous_page_number }}&size={{ page_size }}&filter={{ current_filter }}&sort={{ current_sort }}&date={{ date_query }}">‹</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">«</span></li>
        <li class="page-item disabled"><span class="page-link">‹</span></li>
      {% endif %}

      {% for num in records_list.paginator.page_range %}
        {% if num >= records_list.number|add:'-2' and num <= records_list.number|add:'2' %}

          {% if num == records_list.number %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% else %}
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ num }}&size={{ page_size }}&filter={{ current_filter }}&sort={{ current_sort }}&date={{ date_query }}">
                {{ num }}
              </a>
            </li>
          {% endif %}

        {% endif %}
      {% endfor %}

      {% if records_list.has_next %}
        <li class="page-item">
          <a class="page-link"
             href="?page={{ records_list.next_page_number }}&size={{ page_size }}&filter={{ current_filter }}&sort={{ current_sort }}&date={{ date_query }}">›</a>
        </li>

        <li class="page-item">
          <a class="page-link"
             href="?page={{ records_list.paginator.num_pages }}&size={{ page_size }}&filter={{ current_filter }}&sort={{ current_sort }}&date={{ date_query }}">»</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">›</span></li>
        <li class="page-item disabled"><span class="page-link">»</span></li>
      {% endif %}

    </ul>
  </nav>
</div>



<!-- FILTER SCRIPT -->
<script>
function applyFilters() {
    const filter = document.getElementById("filterSelect").value;
    const sort = document.getElementById("sortSelect").value;
    const date = document.getElementById("dateInput").value;

    const params = new URLSearchParams(window.location.search);

    params.set("filter", filter);
    params.set("sort", sort);

    if (date.trim() !== "") {
        params.set("date", date.trim());
    } else {
        params.delete("date");
    }

    params.set("page", 1);  // always reset to page 1

    window.location = "?" + params.toString();
}
</script>

{% endblock %}
